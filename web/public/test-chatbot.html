<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dify Chatbot Origin Update Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 50px auto;
        padding: 20px;
      }
      .control-panel {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      button {
        background: #1c64f2;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #1a56db;
      }
      .info {
        background: #e7f3ff;
        padding: 15px;
        border-left: 4px solid #1c64f2;
        margin: 10px 0;
      }
      input {
        padding: 8px;
        width: 300px;
        margin: 5px;
      }
      #log {
        background: #000;
        color: #0f0;
        padding: 15px;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§ª Dify Chatbot Origin Update Test</h1>

    <div class="info">
      <strong>æ¸¬è©¦ç›®çš„ï¼š</strong>é©—è­‰ chatbot èƒ½å¦é€é
      <code>postMessage</code> å‹•æ…‹æ›´æ–° <code>origin</code> åƒæ•¸ã€‚
    </div>

    <div class="control-panel">
      <h3>æ§åˆ¶é¢æ¿</h3>

      <div>
        <label>ç•¶å‰ Originï¼š</label>
        <input type="text" id="originInput" value="https://example.com" />
        <button onclick="updateOrigin()">ğŸ“¤ æ›´æ–° Origin</button>
      </div>

      <div style="margin-top: 15px">
        <button onclick="resetChat()">ğŸ”„ é‡ç½®å°è©±</button>
        <button onclick="checkConfig()">ğŸ” æª¢æŸ¥ç•¶å‰é…ç½®</button>
        <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
      </div>
    </div>

    <div class="info">
      <strong>æ“ä½œèªªæ˜ï¼š</strong>
      <ol>
        <li>
          ä¿®æ”¹ä¸Šæ–¹çš„ Origin è¼¸å…¥æ¡†ï¼ˆä¾‹å¦‚æ”¹æˆ <code>https://test.com</code>ï¼‰
        </li>
        <li>é»æ“Šã€Œæ›´æ–° Originã€æŒ‰éˆ•</li>
        <li>æ‰“é–‹ç€è¦½å™¨ Consoleï¼Œæª¢æŸ¥æ˜¯å¦æ”¶åˆ° <code>postMessage</code></li>
        <li>
          åœ¨ chatbot ä¸­ç™¼é€è¨Šæ¯ï¼Œæª¢æŸ¥å¾Œç«¯æ—¥èªŒä¸­çš„ <code>origin</code> æ˜¯å¦å·²æ›´æ–°
        </li>
      </ol>
    </div>

    <div id="log">
      <div>[ç³»çµ±] æ¸¬è©¦é é¢å·²è¼‰å…¥</div>
      <div>[æç¤º] è«‹å…ˆåœ¨ window.difyChatbotConfig ä¸­é…ç½®æ‚¨çš„ chatbot token</div>
    </div>

    <!-- Dify Chatbot Script -->
    <script>
      // é…ç½®æ‚¨çš„ chatbot
      window.difyChatbotConfig = {
        token: "EzLkESGW0zOk0bwj", // è«‹æ›¿æ›æˆæ‚¨çš„ token
        baseUrl: "http://localhost:3000", // æŒ‡å‘æ‚¨æœ¬åœ°çš„ Dify æœå‹™
        inputs: {
          origin: "https://initial-domain.com", // åˆå§‹ origin
        },
      };

      function log(message, type = "info") {
        const logDiv = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();
        const color =
          type === "error"
            ? "#ff6b6b"
            : type === "success"
              ? "#51cf66"
              : "#0f0";
        logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function updateOrigin() {
        const newOrigin = document.getElementById("originInput").value;

        // æ›´æ–° window.difyChatbotConfig
        window.difyChatbotConfig.inputs.origin = newOrigin;
        log(
          `âœ… å·²æ›´æ–° window.difyChatbotConfig.inputs.origin = "${newOrigin}"`,
          "success",
        );

        // ç™¼é€ postMessage çµ¦ iframe
        const iframe = document.getElementById("dify-chatbot-bubble-window");
        if (iframe && iframe.contentWindow) {
          iframe.contentWindow.postMessage(
            {
              type: "dify-chatbot-update-inputs",
              payload: {
                inputs: { origin: newOrigin },
              },
            },
            "*",
          );
          log(`ğŸ“¤ å·²ç™¼é€ postMessage åˆ° chatbot iframe`, "success");
        } else {
          log(`âŒ æ‰¾ä¸åˆ° chatbot iframeï¼Œè«‹ç¢ºèª chatbot å·²è¼‰å…¥`, "error");
        }
      }

      function resetChat() {
        const iframe = document.getElementById("dify-chatbot-bubble-window");
        if (iframe && iframe.contentWindow) {
          iframe.contentWindow.postMessage(
            {
              type: "dify-chatbot-reset",
            },
            "*",
          );
          log(`ğŸ”„ å·²ç™¼é€é‡ç½®æŒ‡ä»¤`, "success");
        } else {
          log(`âŒ æ‰¾ä¸åˆ° chatbot iframe`, "error");
        }
      }

      function checkConfig() {
        log(`ğŸ“‹ ç•¶å‰é…ç½®ï¼š`, "info");
        log(`   - token: ${window.difyChatbotConfig.token}`, "info");
        log(`   - baseUrl: ${window.difyChatbotConfig.baseUrl}`, "info");
        log(`   - origin: ${window.difyChatbotConfig.inputs.origin}`, "info");
      }

      function clearLog() {
        document.getElementById("log").innerHTML =
          "<div>[ç³»çµ±] æ—¥èªŒå·²æ¸…é™¤</div>";
      }

      // ç›£è½ä¾†è‡ª iframe çš„è¨Šæ¯
      window.addEventListener("message", (event) => {
        if (event.data.type === "dify-chatbot-iframe-ready") {
          log(`âœ… Chatbot iframe å·²å°±ç·’`, "success");
        }
      });

      // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºåˆå§‹é…ç½®
      window.addEventListener("load", () => {
        setTimeout(() => {
          checkConfig();
        }, 1000);
      });
    </script>

    <!-- è¼‰å…¥æ‚¨æœ¬åœ°çš„ embed.min.js -->
    <script src="http://localhost:3000/embed.min.js" defer></script>
  </body>
</html>
