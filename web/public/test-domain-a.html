<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domain A - Chatbot Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .header {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .info-box {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #fff;
        }
        code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .domain-badge {
            display: inline-block;
            background: #ff6b6b;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸŒ Domain A æ¸¬è©¦é é¢</h1>
        <div class="domain-badge">æ¨¡æ“¬åŸŸå: https://domain-a.example.com</div>
    </div>

    <div class="info-box">
        <h3>ğŸ“‹ ç•¶å‰é…ç½®</h3>
        <p><strong>Origin:</strong> <code id="current-origin">è¼‰å…¥ä¸­...</code></p>
        <p><strong>User ID:</strong> <code>test-user-123</code></p>
        <p><strong>Token:</strong> <code>EzLkESGW0zOk0bwj</code></p>
    </div>

    <div class="info-box">
        <h3>âœ… æ¸¬è©¦æ­¥é©Ÿ</h3>
        <ol>
            <li>åœ¨æ­¤é é¢é–‹å•Ÿ chatbot ä¸¦ç™¼é€ä¸€å‰‡è¨Šæ¯</li>
            <li>æ‰“é–‹ <a href="/test-domain-b.html" style="color: #ffd93d; font-weight: bold;">Domain B æ¸¬è©¦é é¢</a></li>
            <li>åœ¨ Domain B é é¢ä¹Ÿç™¼é€ä¸€å‰‡è¨Šæ¯</li>
            <li>æª¢æŸ¥å¾Œç«¯æ—¥èªŒï¼Œç¢ºèªå…©å€‹åŸŸåçš„ <code>origin</code> åƒæ•¸ä¸åŒ</li>
        </ol>
    </div>

    <div class="info-box">
        <h3>ğŸ” é æœŸçµæœ</h3>
        <p>åœ¨ Domain A ç™¼é€çš„è¨Šæ¯ï¼Œå¾Œç«¯æ‡‰è©²æ”¶åˆ°ï¼š</p>
        <code>origin: "https://domain-a.example.com"</code>
    </div>

    <script>
        // é…ç½® Chatbot - Domain A
        window.difyChatbotConfig = {
            token: 'EzLkESGW0zOk0bwj',
            baseUrl: 'http://localhost:3000',
            inputs: {
                origin: 'https://domain-a.example.com'  // Domain A çš„ origin
            }
        };

        // é¡¯ç¤ºç•¶å‰é…ç½®
        document.getElementById('current-origin').textContent = window.difyChatbotConfig.inputs.origin;

        // æ””æˆªæ‰€æœ‰ postMessageï¼Œè¨˜éŒ„ç™¼é€å’Œæ¥æ”¶
        const originalPostMessage = window.postMessage.bind(window);
        window.postMessage = function(...args) {
            console.log('ğŸ“¤ [Host] postMessage ç™¼é€:', args[0]);
            return originalPostMessage(...args);
        };

        // ç›£è½ä¾†è‡ª iframe çš„è¨Šæ¯
        window.addEventListener('message', (event) => {
            console.log('ğŸ“¥ [Host] æ”¶åˆ° message:', {
                type: event.data.type,
                payload: event.data.payload,
                origin: event.origin
            });

            if (event.data.type === 'dify-chatbot-iframe-ready') {
                console.log('âœ… Chatbot iframe å·²å°±ç·’');
                console.log('ğŸ“¤ è‡ªå‹•ç™¼é€ origin:', window.difyChatbotConfig.inputs.origin);
                
                // è¨˜éŒ„åˆ°é é¢ä¸Š
                const logDiv = document.createElement('div');
                logDiv.style.cssText = 'background: #d4edda; padding: 10px; margin: 10px 0; border-left: 4px solid #28a745; border-radius: 4px;';
                logDiv.innerHTML = `
                    <strong>âœ… è‡ªå‹•åŒæ­¥æˆåŠŸï¼</strong><br>
                    æ™‚é–“: ${new Date().toLocaleTimeString()}<br>
                    ç™¼é€çš„ origin: <code>${window.difyChatbotConfig.inputs.origin}</code><br>
                    <small>é€™è­‰æ˜äº† embed.js æœƒè‡ªå‹•å¾ window.difyChatbotConfig è®€å– origin ä¸¦ç™¼é€çµ¦ iframe</small>
                `;
                document.body.appendChild(logDiv);
            }

            if (event.data.type === 'dify-chatbot-update-inputs') {
                console.log('ğŸ”„ [iframe] æ”¶åˆ° update-inputs æŒ‡ä»¤');
                console.log('   æ–°çš„ inputs:', event.data.payload.inputs);
                
                // è¨˜éŒ„åˆ°é é¢ä¸Š
                const logDiv = document.createElement('div');
                logDiv.style.cssText = 'background: #cce5ff; padding: 10px; margin: 10px 0; border-left: 4px solid #004085; border-radius: 4px;';
                logDiv.innerHTML = `
                    <strong>ğŸ”„ iframe æ”¶åˆ°æ›´æ–°æŒ‡ä»¤</strong><br>
                    æ™‚é–“: ${new Date().toLocaleTimeString()}<br>
                    æ–°çš„ origin: <code>${event.data.payload.inputs.origin}</code>
                `;
                document.body.appendChild(logDiv);
            }
        });

        // æ””æˆª iframe çš„ postMessage
        const originalIframePostMessage = HTMLIFrameElement.prototype.contentWindow;
        Object.defineProperty(HTMLIFrameElement.prototype, 'contentWindow', {
            get: function() {
                const win = originalIframePostMessage;
                if (win && win.postMessage) {
                    const originalMethod = win.postMessage.bind(win);
                    win.postMessage = function(...args) {
                        console.log('ğŸ“¤ [Hostâ†’iframe] postMessage:', args[0]);
                        return originalMethod(...args);
                    };
                }
                return win;
            }
        });

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºåˆå§‹é…ç½®
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('ğŸ“‹ ç•¶å‰é…ç½®ï¼š');
                console.log('   - token:', window.difyChatbotConfig.token);
                console.log('   - baseUrl:', window.difyChatbotConfig.baseUrl);
                console.log('   - origin:', window.difyChatbotConfig.inputs.origin);
            }, 1000);
        });
    </script>

    <!-- è¼‰å…¥æœ¬åœ°çš„ embed.min.js -->
    <script src="http://localhost:3000/embed.min.js" defer></script>
</body>
</html>
